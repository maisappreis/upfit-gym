import{d as W,C as Z,b as ee,s as $,e as b,g as r,i as u,j as i,t as ae,l as v,m as c,x as V,f as _,M as de,z as ce,N as Q,T as F,c as L,o as te,F as Y,B as j,w as me,a as ve,I as pe,y as D,S as fe}from"./index-CNMUdzAR.js";import{e as le,u as ge,a as ye,B as he,M as oe,T as _e,P as Ve,c as X,d as ke,f as be,S as Ce}from"./StatusFilter.vue_vue_type_script_setup_true_lang-D8VgU5Cl.js";import{f as Re,b as se,m as Me,y as Se,d as $e}from"./dataUtils-D26YddNY.js";import{B as x}from"./BaseButton-CiHY4qwR.js";import{_ as Pe}from"./DateFilter.vue_vue_type_script_setup_true_lang-Nwv7r-Yi.js";import{_ as q}from"./BaseSelect.vue_vue_type_script_setup_true_lang-Dyd7NWUX.js";const we={key:0},Ue=["onClick"],xe={class:"align-right"},ze=["onMouseenter"],Fe={key:1,class:"not-found"},Le={class:"message-area"},Ne=W({__name:"RevenuesTable",props:{data:{},searchedField:{}},emits:["update-item","delete-item"],setup(N,{emit:h}){const C=Z(),p=ee(),f=N,M=le(),{hoveredId:o,refsMap:U,setRef:k}=ge(),{itemsPerPage:s,currentPage:t,paginatedData:m}=ye(()=>f.data,()=>f.searchedField),S=$(""),R=$(""),P=$(),E=[{key:"year",label:"Ano"},{key:"month",label:"Mês"},{key:"name",label:"Nome"},{key:"start",label:"Início"},{key:"plan",label:"Plano"},{key:"payment_day",label:"Venc."},{key:"value",label:"Valor"},{key:"paid",label:"Status"},{key:"actions",label:""}],B=n=>{switch(P.value=n,P.value.paid){case"À pagar":R.value="link enviado";break;case"Link enviado":R.value="pago";break;case"Pago":R.value="à pagar";break}M.openUpdate(P.value)},T=()=>{M.close(),R.value=""},I=async()=>{p.start();try{let n={};switch(P.value.paid){case"À pagar":n={paid:"Link enviado"};break;case"Link enviado":n={paid:"Pago"};break;case"Pago":n={paid:"À pagar"};break}await F.update(P.value.id,n),n.paid==="Pago"&&P.value.status==="Ativo"&&A(P.value),await C.fetchRevenue(),T(),S.value="Status do pagamento salvo com sucesso!"}catch(n){console.error("Erro ao atualizar o status de pagamento...",n),S.value="Erro ao salvar o status do pagamento."}finally{p.stop()}},A=async n=>{try{let d=se(n.month,n.year),l={customer:n.customer,year:d.year,month:d.month,value:n.value,payment_day:n.payment_day,notes:n.notes,paid:"À pagar"};await F.create(l),await C.fetchRevenue()}catch(d){console.error("Erro ao criar receita.",d)}};return(n,d)=>{const z=ae("font-awesome-icon");return v(),b("div",null,[r(m).length>0?(v(),b("div",we,[u(he,{data:r(m),columns:E,rowKey:"id"},{"cell-start":i(({row:l})=>[c(V(r(Re)(l.start)),1)]),"cell-value":i(({row:l})=>[c(" R$ "+V(l.value.toFixed(2).toString().replace(/\./g,",")),1)]),"cell-paid":i(({row:l})=>[_("span",{class:de(["status paid",{active:l.paid==="Pago",inactive:l.paid==="À pagar",sent:l.paid==="Link enviado"}]),onClick:w=>B(l)},V(l.paid),11,Ue)]),"cell-actions":i(({row:l})=>[_("span",xe,[l.notes?(v(),b("span",{key:0,ref:w=>r(k)(l.id,w),onMouseenter:w=>o.value=l.id,onMouseleave:d[0]||(d[0]=w=>o.value=null)},[u(z,{icon:"fa-solid fa-circle-info",class:"table-icon"})],40,ze)):ce("",!0),u(_e,{anchor:r(U)[l.id],visible:r(o)===l.id},{default:i(()=>[c(V(l.notes),1)]),_:2},1032,["anchor","visible"]),u(z,{icon:"fa-solid fa-pen-to-square",class:"table-icon",onClick:w=>n.$emit("update-item",l)},null,8,["onClick"]),u(z,{icon:"fa-solid fa-trash-can",class:"table-icon",onClick:w=>n.$emit("delete-item",l)},null,8,["onClick"])])]),footer:i(()=>[u(Ve,{currentPage:r(t),"onUpdate:currentPage":d[1]||(d[1]=l=>Q(t)?t.value=l:null),itemsPerPage:r(s),"onUpdate:itemsPerPage":d[2]||(d[2]=l=>Q(s)?s.value=l:null),totalItems:n.data.length},null,8,["currentPage","itemsPerPage","totalItems"])]),_:1},8,["data"])])):(v(),b("div",Fe," Nenhum resultado foi encontrado. ")),u(oe,{modelValue:r(M).isOpen.value,"onUpdate:modelValue":d[3]||(d[3]=l=>r(M).isOpen.value=l)},{header:i(()=>[_("span",null,[c(" Marcar como "),_("strong",null,V(R.value),1)])]),footer:i(()=>[u(x,{size:"lg",loading:r(p).isLoading,onClick:I},{default:i(()=>[c(" Confirmar ")]),_:1},8,["loading"]),u(x,{size:"lg",variant:"danger",onClick:T},{default:i(()=>[c(" Cancelar ")]),_:1})]),default:i(()=>[_("p",Le,[c(" Gostaria de marcar essa receita como "),_("strong",null,V(R.value),1),c("? ")])]),_:1},8,["modelValue"])])}}}),Te=["value"],De={class:"form-item",style:{"justify-content":"space-between"}},Ee=["value"],Be=["value"],Ie=W({__name:"RevenueForm",props:{modelValue:{},customersList:{},months:{},years:{}},emits:["update:modelValue"],setup(N,{expose:h,emit:C}){const p=N,f=C,M=$(null),o=L({get:()=>p.modelValue,set:k=>f("update:modelValue",k)}),U=L(()=>o.value.customer!==null&&o.value.year!==0&&o.value.month!==""&&o.value.value!==0&&o.value.payment_day!==0);return te(()=>{var k;(k=M.value)==null||k.focus()}),h({isValid:U}),(k,s)=>(v(),b("form",{class:"form-area",onSubmit:s[6]||(s[6]=me(()=>{},["prevent"]))},[u(q,{label:"Cliente",modelValue:o.value.customer,"onUpdate:modelValue":s[0]||(s[0]=t=>o.value.customer=t),ref_key:"firstInput",ref:M},{default:i(()=>[(v(!0),b(Y,null,j(k.customersList,(t,m)=>(v(),b("option",{key:m,value:t.id},V(t.name),9,Te))),128))]),_:1},8,["modelValue"]),u(X,{label:"Valor",modelValue:o.value.value,"onUpdate:modelValue":s[1]||(s[1]=t=>o.value.value=t),type:"number"},null,8,["modelValue"]),u(X,{label:"Dia do Vencimento",modelValue:o.value.payment_day,"onUpdate:modelValue":s[2]||(s[2]=t=>o.value.payment_day=t),type:"number",min:"1",max:"31"},null,8,["modelValue"]),_("div",De,[u(q,{label:"Receber em",modelValue:o.value.month,"onUpdate:modelValue":s[3]||(s[3]=t=>o.value.month=t)},{default:i(()=>[(v(!0),b(Y,null,j(k.months,(t,m)=>(v(),b("option",{key:m,value:t},V(t),9,Ee))),128))]),_:1},8,["modelValue"]),u(q,{modelValue:o.value.year,"onUpdate:modelValue":s[4]||(s[4]=t=>o.value.year=t),style:{width:"120px"}},{default:i(()=>[(v(!0),b(Y,null,j(k.years,(t,m)=>(v(),b("option",{key:m,value:t},V(t),9,Be))),128))]),_:1},8,["modelValue"])]),u(ke,{label:"Notas",modelValue:o.value.notes,"onUpdate:modelValue":s[5]||(s[5]=t=>o.value.notes=t)},null,8,["modelValue"])],32))}}),Ae={class:"content-area"},Oe={class:"flex space-between mb-normal"},Ye=_("span",{class:"text-add"},"Nova Receita",-1),je={style:{display:"flex","justify-content":"flex-end"}},qe={key:0,class:"message-area"},We={class:"highlight"},Ge={class:"highlight"},Ke={class:"highlight"},He={key:1,class:"message-area"},Je={class:"highlight"},Qe={class:"highlight"},oa=W({__name:"RevenuePage",setup(N){const h=Z(),C=ve(),p=ee(),f=le(),M=$([]),o=$(""),U=$(0),k=$(""),s=$(!1),t=$(null),m=$({customer:null,month:"",notes:"",paid:"À pagar",payment_day:null,value:null,year:null}),S=L(()=>f.entity.value),R=L(()=>h.customers.find(e=>e.id===S.value.customer)),P=L(()=>{switch(f.mode.value){case"create":return"Adicionar Receita";case"update":return"Atualizar Receita";case"delete":return"Excluir Receita";default:return""}}),E=L(()=>$e(h.revenue,{currentMonth:o.value,currentYear:U.value,currentStatus:k.value})),B=async()=>{T(),await I(),d(),await h.fetchData()},T=()=>{let e=se(S.value.month,S.value.year),a=h.revenue.filter(g=>g.month===e.month&&g.year===e.year);for(let g=0;g<a.length;g++)A(a[g].id)},I=async()=>{p.start();try{let e={value:m.value.value};await fe.update(S.value.customer,e),C.success("Cliente atualizado com sucesso!")}catch(e){C.error("Erro ao atualizar cliente.",e)}finally{p.stop()}},A=async e=>{try{let a={value:m.value.value};await F.update(e,a)}catch(a){console.error("Erro ao atualizar receita.",a)}},n=e=>e.toFixed(2).toString().replace(/\./g,","),d=()=>{f.close(),s.value=!1,m.value={customer:null,month:"",notes:"",paid:"À pagar",payment_day:null,value:null,year:null}},z=e=>{m.value={customer:e.customer,month:e.month,notes:e.notes,paid:e.paid,payment_day:e.payment_day,value:e.value,year:e.year},f.openUpdate(e)},l=e=>{f.openDelete(e)},w=async()=>{var a;if(!((a=t.value)!=null&&a.isValid))return;const e={...m.value};f.mode.value==="create"?ne(e):ue(S.value.id,e)},ne=async e=>{p.start();try{await F.create({...e,paid:"À pagar"}),await h.fetchRevenue(),d(),C.success("Receita criada com sucesso!")}catch(a){C.error("Erro ao criar receita.",a)}finally{p.stop()}},ue=async(e,a)=>{p.start();try{await F.update(e,a),await h.fetchRevenue(),re(),C.success("Receita atualizada com sucesso!")}catch(g){C.error("Erro ao atualizar receita.",g)}finally{p.stop()}},re=()=>{R.value&&(R.value.value!==Number(m.value.value)?(f.openUpdate(S.value),s.value=!0):d())},ie=async()=>{p.start();try{await F.delete(S.value.id),await h.fetchRevenue(),C.success("Receita excluída com sucesso!"),d()}catch(e){C.error("Erro ao excluir receita.",e)}finally{p.stop()}},G=()=>{h.customers.forEach(e=>{h.revenue.filter(g=>g.customer===e.id).forEach(g=>{g.name=e.name,g.start=e.start,g.plan=e.plan,g.status=e.status})})};return pe(()=>h.revenue,()=>{G()}),te(()=>{h.customers&&h.customers.length>0&&G()}),(e,a)=>{const g=ae("font-awesome-icon");return v(),b("div",Ae,[_("div",Oe,[u(x,{size:"lg",onClick:r(f).openCreate},{default:i(()=>[u(g,{icon:"fa-solid fa-plus",class:"icon-add"}),Ye]),_:1},8,["onClick"]),_("div",je,[u(Pe,{modelValueMonth:o.value,"onUpdate:modelValueMonth":a[0]||(a[0]=y=>o.value=y),modelValueYear:U.value,"onUpdate:modelValueYear":a[1]||(a[1]=y=>U.value=y)},null,8,["modelValueMonth","modelValueYear"]),u(be,{modelValue:k.value,"onUpdate:modelValue":a[2]||(a[2]=y=>k.value=y),options:["Pago","À pagar","Link enviado","Todos"],defaultValue:"Todos"},null,8,["modelValue"]),u(Ce,{modelValue:M.value,"onUpdate:modelValue":a[3]||(a[3]=y=>M.value=y)},null,8,["modelValue"])])]),u(Ne,{data:E.value,searchedField:M.value,onUpdateItem:a[4]||(a[4]=y=>z(y)),onDeleteItem:l},null,8,["data","searchedField"]),u(oe,{modelValue:r(f).isOpen.value,"onUpdate:modelValue":a[6]||(a[6]=y=>r(f).isOpen.value=y)},{header:i(()=>[_("span",null,V(P.value),1)]),footer:i(()=>{var y;return[r(f).isDelete.value?(v(),D(x,{key:0,loading:r(p).isLoading,onClick:ie},{default:i(()=>[c(" Confimar ")]),_:1},8,["loading"])):s.value?(v(),D(x,{key:1,loading:r(p).isLoading,onClick:B},{default:i(()=>[c(" Confimar ")]),_:1},8,["loading"])):(v(),D(x,{key:2,type:"submit",size:"lg",disabled:!((y=t.value)!=null&&y.isValid),loading:r(p).isLoading,onClick:w},{default:i(()=>[c(" Salvar ")]),_:1},8,["disabled","loading"])),u(x,{size:"lg",variant:"danger",onClick:d},{default:i(()=>[c(" Cancelar ")]),_:1})]}),default:i(()=>{var y,K,H,J;return[s.value?(v(),b("p",qe,[c(" O valor atual da mensalidade do cliente "),_("strong",We,V((y=R.value)==null?void 0:y.name),1),c(" é de "),_("strong",Ge,"R$"+V(n((K=R.value)==null?void 0:K.value)),1),c(" segundo o seu cadastro. Você gostaria de atualizar todos os futuros pagamentos deste cliente para este novo valor de "),_("strong",Ke,"R$"+V(n(Number(m.value.value))),1),c("? ")])):r(f).isDelete.value?(v(),b("p",He,[c(" Tem certeza que deseja excluir o recebimento da mensalidade do cliente "),_("strong",Je,V((H=R.value)==null?void 0:H.name),1),c(" referente ao mês de "),_("strong",Qe,V((J=S.value)==null?void 0:J.month),1),c("? ")])):(v(),D(Ie,{key:2,modelValue:m.value,"onUpdate:modelValue":a[5]||(a[5]=O=>m.value=O),months:r(Me),years:r(Se),"customers-list":r(h).customers.filter(O=>O.status==="Ativo"),ref_key:"formRef",ref:t},null,8,["modelValue","months","years","customers-list"]))]}),_:1},8,["modelValue"])])}}});export{oa as default};
